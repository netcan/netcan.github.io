---
title: 家用软路由折腾记（技术流）
toc: true
original: true
date: 2023-01-14 10:26:46
tags:
- Linux
categories:
- 随笔
---

## 缘由
最近在折腾软路由，起因是发现家里无线路由器跑科学跑不满带宽，经过观察发现瓶颈在CPU上，于是想到要整个更强劲的路由器，经过一番调研，性能强劲的路由器都不便宜，于是决定采用软路由方案。

软路由相当于一台低功耗的电脑，可以自由地跑一些操作系统，例如OpenWrt系统专门做路由系统，非常适合折腾。

## 软路由选型
目前软路由硬件体系有两大类，分别是x86和arm架构，x86可以折腾的范围更广，例如可以跑windows系统，跑虚拟化，挂一堆虚拟机。但是x86一整套下来（硬盘+内存）普遍价格要比arm贵得多，基本上千，而arm只需要几百块，缺点是硬件可扩展性要差些。

我对虚拟化和windows不感冒，对x86也没什么好感，所幸选择了arm架构，对我来说Linux系统足够给力，并且也可以跑一些docker容器，如下是我整套的配置：

![2023-01-14T105409](2023-01-14T105409.png)

闪绿色的灯即为软路由，在咸鱼上花了400买的，六核cpu（双核A72+四核A53）+ 4G内存 + 两个USB3.0，需要额外的sdcard启动系统，它作为主路由桥接光猫拨号上网，并且旁边的无线路由器作为桥接AP，外接一个硬盘盒挂载16T的希捷银河企业盘做NAS。

## 系统选型
起初我是选用OpenWrt作为软路由系统，那时候还没有买16T硬盘，只是挂接着大学闲置了4年的西数1T硬盘作为NAS，读写速度能够到达50MBps，千兆局域网速度完全带得动。

OpenWrt支持docker，这样大大简化了服务的部署方式，例如部署Syncthing服务，将手机照片同步到硬盘上，只需要一行命令：

```bash
docker run -d -v /mnt/nas/syncthing:/var/syncthing --restart=always -p 22000:22000 -p 21027:21027/udp -p 8384:8384 syncthing/syncthing:latest
```

手机也安装Syncthing客户端：

![2023-01-14T120246](2023-01-14T120246.png)

然后通过朋友zhiyb给我邀请进了pt站（内站hdtime和外站torrentleech），在他的建议下使用aria伪装正经客户端做种，玩的比较开心。

在下载了一段时间后，发现文件系统经常损坏，这时候我才意识到，硬盘可能出问题了，得考虑换硬盘。在这种情况下，外站torrentleech由于分享率不达标被banned了，没救回来：

![2023-01-14T113421](2023-01-14T113421.png)

玩pt站要求还是有的，在torrentleech站主要违反了两条规则：
- 分享率（上传量和下载量的比值）要大于0.4
- 下载的资源必须得做种一段时间后，才能删除

当然以上都是由于硬盘的不靠谱导致的，于是我考虑使用硬盘盒+机械硬盘的方案。考虑到硬盘容量（16T）比较大，而且未来有组RAID的想法，我决定使用zfs文件系统，而OpenWrt目前是不支持zfs的，因为zfs需要kernel支持，而且没在主线中，并且工具链也无法支撑构建完整的支持。

这时候考虑使用正经的Linux系统，例如Debian操作系统，经过一番搜索，发现armbian操作系统是基于debian的，顾名思义是针对arm开发板所优化的操作系统，于是它成为我最终所使用的操作系统。

![2023-01-14T120932](2023-01-14T120932.png)

使用正经的操作系统有另一个好处是，可以直接在软路由上编译软件，而OpenWrt编译就需要使用一整套交叉编译器了。

## Armbian折腾记
待续