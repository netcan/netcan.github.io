<!DOCTYPE html>


  <html class="light page-post">


<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>C++20 åç¨‹åˆæ¢ | Netcan on Programming</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="C/C++,åç¨‹," />
  

  <meta name="description" content="C++20 ç»ˆäºå¼•å…¥äº†åç¨‹ç‰¹æ€§ï¼Œç»™åº“ä½œè€…æä¾›äº†ä¸€ä¸ªå®ç°åç¨‹çš„æœºåˆ¶ï¼Œè®©ç”¨æˆ·æ–¹ä¾¿ä½¿ç”¨åç¨‹æ¥ç¼–å†™å¼‚æ­¥é€»è¾‘ï¼Œé™ä½äº†å¼‚æ­¥å¹¶å‘ç¼–ç¨‹çš„éš¾åº¦ã€‚ç»“åˆæˆ‘æœ€è¿‘åç¨‹çš„å­¦ä¹ ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹ç›¸å…³å†…å®¹ã€‚ ä½¿ç”¨åœºæ™¯ åç¨‹å’Œæ™®é€šå‡½æ•°ç›¸æ¯”ï¼Œå¤šäº†ä¸ªä¸­é€”éšæ—¶  æŒ‚èµ· ï¼Œéšå æ¢å¤  çš„è¿‡ç¨‹ï¼Œå½“ç”¨æˆ·è°ƒç”¨ä¸€ä¸ªé˜»å¡è¯·æ±‚æ¥å£ï¼Œä»è€Œè®©å‡ºæ§åˆ¶æƒï¼Œå½“å“åº”æ—¶ï¼Œæ¢å¤ä¹‹å‰çš„æ§åˆ¶æµï¼Œä»è€Œå¤§å¤§æé«˜çº¿ç¨‹å¤ç”¨ç‡ï¼Œè¿™ä¹Ÿæ³¨æ„äº†åç¨‹åªæ˜¯å¹¶å‘çš„ï¼Œå¹¶ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶è¡Œï¼Œåœ¨">
<meta property="og:type" content="article">
<meta property="og:title" content="C++20 åç¨‹åˆæ¢">
<meta property="og:url" content="https://netcan.github.io/2020/09/05/C-20%E5%8D%8F%E7%A8%8B/index.html">
<meta property="og:site_name" content="Netcan on Programming">
<meta property="og:description" content="C++20 ç»ˆäºå¼•å…¥äº†åç¨‹ç‰¹æ€§ï¼Œç»™åº“ä½œè€…æä¾›äº†ä¸€ä¸ªå®ç°åç¨‹çš„æœºåˆ¶ï¼Œè®©ç”¨æˆ·æ–¹ä¾¿ä½¿ç”¨åç¨‹æ¥ç¼–å†™å¼‚æ­¥é€»è¾‘ï¼Œé™ä½äº†å¼‚æ­¥å¹¶å‘ç¼–ç¨‹çš„éš¾åº¦ã€‚ç»“åˆæˆ‘æœ€è¿‘åç¨‹çš„å­¦ä¹ ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹ç›¸å…³å†…å®¹ã€‚ ä½¿ç”¨åœºæ™¯ åç¨‹å’Œæ™®é€šå‡½æ•°ç›¸æ¯”ï¼Œå¤šäº†ä¸ªä¸­é€”éšæ—¶  æŒ‚èµ· ï¼Œéšå æ¢å¤  çš„è¿‡ç¨‹ï¼Œå½“ç”¨æˆ·è°ƒç”¨ä¸€ä¸ªé˜»å¡è¯·æ±‚æ¥å£ï¼Œä»è€Œè®©å‡ºæ§åˆ¶æƒï¼Œå½“å“åº”æ—¶ï¼Œæ¢å¤ä¹‹å‰çš„æ§åˆ¶æµï¼Œä»è€Œå¤§å¤§æé«˜çº¿ç¨‹å¤ç”¨ç‡ï¼Œè¿™ä¹Ÿæ³¨æ„äº†åç¨‹åªæ˜¯å¹¶å‘çš„ï¼Œå¹¶ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶è¡Œï¼Œåœ¨">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-09-05T06:36:19.000Z">
<meta property="article:modified_time" content="2022-12-09T11:02:08.581Z">
<meta property="article:author" content="Netcan">
<meta property="article:tag" content="C&#x2F;C++">
<meta property="article:tag" content="åç¨‹">
<meta name="twitter:card" content="summary">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbeddx" rel="stylesheet">


  
    
<link rel="stylesheet" href="/css/site.css">

  

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-174901164-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?d2c292719a76d8c0fa7f9874379cfd25";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>



  
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

<meta name="generator" content="Hexo 5.0.0"><link rel="alternate" href="/atom.xml" title="Netcan on Programming" type="application/atom+xml">
<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body>


  
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><span id="toolbox-mobile" class="toolbox-mobile">ROOT</span>
  

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css"/>
<link rel="stylesheet" href="/css/prism.css">

<div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">ROOT</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            åšå®¢
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/category/"
            rel="noopener noreferrer"
            target="_self"
            >
            åˆ†ç±»
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            rel="noopener noreferrer"
            target="_self"
            >
            æ ‡ç­¾
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            rel="noopener noreferrer"
            target="_self"
            >
            å…³äº
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/atom.xml"
            rel="noopener noreferrer"
            target="_blank"
            >
            RSS
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            rel="noopener noreferrer"
            target="_self"
            >
            æœç´¢
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">æ–‡ç« ç›®å½•</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">ä½¿ç”¨åœºæ™¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5%E6%A8%A1%E5%9E%8B"><span class="toc-text">æ¦‚å¿µæ¨¡å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Promise"><span class="toc-text">Promise</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Future"><span class="toc-text">Future</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Awaitable"><span class="toc-text">Awaitable</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%9C%BA%E5%88%B6"><span class="toc-text">å…·ä½“æœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Promise-Future%20%E5%AF%B9%E8%B1%A1"><span class="toc-text">Promise&#x2F;Future å¯¹è±¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Awaitable%20%E5%AF%B9%E8%B1%A1"><span class="toc-text">Awaitable å¯¹è±¡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B%E5%AE%9E%E6%88%98"><span class="toc-text">åç¨‹å®æˆ˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">æ€»ç»“</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-C-20åç¨‹" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">C++20 åç¨‹åˆæ¢</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2020.09.05</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>Netcan</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">å­¦ä¹ ç¬”è®°</a>
  </span>



      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbspçƒ­åº¦ <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>â„ƒ
        </span>
      
      
    </div>
  </header>

  <div class="article-content">
    
      <p>C++20 ç»ˆäºå¼•å…¥äº†åç¨‹ç‰¹æ€§ï¼Œç»™åº“ä½œè€…æä¾›äº†ä¸€ä¸ªå®ç°åç¨‹çš„æœºåˆ¶ï¼Œè®©ç”¨æˆ·æ–¹ä¾¿ä½¿ç”¨åç¨‹æ¥ç¼–å†™å¼‚æ­¥é€»è¾‘ï¼Œé™ä½äº†å¼‚æ­¥å¹¶å‘ç¼–ç¨‹çš„éš¾åº¦ã€‚ç»“åˆæˆ‘æœ€è¿‘åç¨‹çš„å­¦ä¹ ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹ç›¸å…³å†…å®¹ã€‚</p>
<h2 id="ä½¿ç”¨åœºæ™¯">ä½¿ç”¨åœºæ™¯</h2>
<p>åç¨‹å’Œæ™®é€šå‡½æ•°ç›¸æ¯”ï¼Œå¤šäº†ä¸ªä¸­é€”éšæ—¶ <strong> æŒ‚èµ· </strong>ï¼Œéšå<strong> æ¢å¤ </strong> çš„è¿‡ç¨‹ï¼Œå½“ç”¨æˆ·è°ƒç”¨ä¸€ä¸ªé˜»å¡è¯·æ±‚æ¥å£ï¼Œä»è€Œè®©å‡ºæ§åˆ¶æƒï¼Œå½“å“åº”æ—¶ï¼Œæ¢å¤ä¹‹å‰çš„æ§åˆ¶æµï¼Œä»è€Œå¤§å¤§æé«˜çº¿ç¨‹å¤ç”¨ç‡ï¼Œè¿™ä¹Ÿæ³¨æ„äº†åç¨‹åªæ˜¯å¹¶å‘çš„ï¼Œå¹¶ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶è¡Œï¼Œåœ¨ IO å¯†é›†å‹åœºæ™¯ä¸‹ï¼Œåç¨‹èƒ½å¤Ÿå¾ˆå¥½çš„æé«˜èµ„æºåˆ©ç”¨ç‡ï¼Œç”¨å°‘æ•°çš„çº¿ç¨‹è¾¾åˆ°å¹¶å‘æˆç™¾ä¸Šä¸‡ä¸ªåç¨‹çš„æ•ˆæœã€‚</p>
<p>è€Œç›¸å¯¹ä¼ ç»Ÿçš„çº¿ç¨‹æ±  + å›è°ƒæ¨¡å¼ï¼Œæ¯å‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œä¸ºäº†é¿å…é˜»å¡å½“å‰çº¿ç¨‹ï¼Œéœ€è¦æŒ‚ä¸€ä¸ªå›è°ƒå‡½æ•°å¤„ç†åç»­è¿‡ç¨‹ï¼Œè€Œå›è°ƒå‡½æ•°åˆå¯èƒ½äº§ç”Ÿç«äº‰ï¼Œå¯¼è‡´å¾—åŠ é”å¤„ç†ã€‚è€Œåç¨‹å´èƒ½å¤Ÿä»¥åŒæ­¥æ–¹å¼å†™å®ç°å¼‚æ­¥ï¼Œåç»­è¿‡ç¨‹ç›´æ¥æŒ‚èµ·ï¼Œå½“å“åº”çš„æ—¶å€™æ¢å¤æ‰§è¡Œã€‚</p>
<p>æˆ‘å‚ä¸çš„é¡¹ç›®ä¸­ï¼Œå¯¹è±¡éšæ—¶éƒ½å¯èƒ½èµ·ä¸ªçº¿ç¨‹å¹²æ´»ï¼Œæˆ–è€…å¸¸é©»äºå¯¹è±¡ç”Ÿå‘½å‘¨æœŸé‡Œï¼Œç»Ÿè®¡ä¸‹æ¥æ•´ä¸ªé¡¹ç›®å±…ç„¶å¼€äº†å‡ ç™¾ä¸ªçº¿ç¨‹ï¼Œç”±äºå¤šçº¿ç¨‹ç¼–ç¨‹éš¾å…å¯¼è‡´ç«äº‰ï¼Œä»è€Œéœ€è¦é”è¿™ç§å¾ˆä½çº§çš„æœºåˆ¶åšåŒæ­¥ï¼Œè€Œä¸€æ—¦å¼•å…¥äº†é”ï¼Œå°±ä¸å¯é¿å…çš„æ‰©æ•£å¼€æ¥ï¼Œå¤§å®¶çœ‹åˆ°è¿™é‡ŒåŠ æŠŠé”ï¼Œé‚£æˆ‘ä¹ŸåŠ æŠŠé”ï¼Œç»Ÿè®¡ä¸‹æ¥ä»£ç é‡Œé¢å±…ç„¶ä¹Ÿæœ‰å‡ ç™¾æŠŠé”ã€‚ã€‚çœŸæ˜¯ç»´æŠ¤çš„å™©æ¢¦å•ŠğŸ¤£</p>
<p>ç”±äºåç¨‹èƒ½å¤Ÿéšæ—¶æŒ‚èµ·ï¼Œåç»­æ¢å¤ï¼Œè¿™å°±èƒ½å®ç°ä¸€äº›å»¶è¿Ÿè®¡ç®—çš„ç‰¹æ€§ï¼Œä¾‹å¦‚ç”Ÿæˆå™¨ã€‚</p>
<p>æ‰¯è¿œäº†ï¼Œæœ¬æ–‡ä¸»é¢˜æ˜¯å…³äº C++20 çš„åç¨‹ï¼Œåœ¨ C++20 è¿˜æ²¡ç¨³å®šä¹‹å‰ï¼Œå…ˆæ¥å­¦ä¹ ä¸€ä¸‹ç›¸å…³çŸ¥è¯†ï¼Œè¯»å®Œæœ¬æ–‡åä½ åº”è¯¥èƒ½åˆ©ç”¨è¿™ä¸ªæœºåˆ¶å®ç°ä¸€äº›æƒ³è¦çš„åç¨‹äº†ã€‚</p>
<h2 id="æ¦‚å¿µæ¨¡å‹">æ¦‚å¿µæ¨¡å‹</h2>
<p>C++20 çš„åç¨‹è®¾è®¡ä¸ºæ— æ ˆåç¨‹ï¼Œç›¸å¯¹äºæœ‰æ ˆåç¨‹ï¼Œçœæ‰äº†ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>ï¼Œåªèƒ½æ‰‹åŠ¨åˆ‡æ¢ï¼Œæ•ˆç‡æ›´é«˜ï¼Œä¹Ÿä¸ç”¨ç®¡ç†å¤æ‚çš„å¯„å­˜å™¨çŠ¶æ€ï¼Œç§»æ¤æ€§æ›´å¥½ï¼Œä½†è¿™åŒæ—¶ä¹Ÿå¯¼è‡´äº†ä¸èƒ½è¢«éåç¨‹å‡½æ•°åµŒå¥—è°ƒç”¨ã€‚</p>
<p>åŒæ—¶å¼•å…¥äº† 3 ä¸ªå…³é”®å­—ï¼š</p>
<ul>
<li>co_yield: æŒ‚èµ·å¹¶è¿”å›å€¼</li>
<li>co_await: æŒ‚èµ·</li>
<li>co_return: ç»“æŸåç¨‹</li>
</ul>
<p>å½“ä¸€ä¸ªå‡½æ•°å‡ºç°äº†ä¸Šé¢çš„å…³é”®å­—ï¼Œåˆ™è¯¥å‡½æ•°æ˜¯ä¸ªåç¨‹ã€‚</p>
<h3 id="Promise">Promise</h3>
<p>å½“ caller è°ƒç”¨ä¸€ä¸ª callee åç¨‹çš„æ—¶å€™ï¼Œåç¨‹è‡ªèº«çš„çŠ¶æ€ä¿¡æ¯ <sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>ï¼ˆå½¢å‚ï¼Œå±€éƒ¨å˜é‡ï¼Œè‡ªå¸¦æ•°æ®ï¼Œå„ä¸ªé˜¶æ®µç‚¹æ‰§è¡Œç‚¹ï¼‰ä¼šè¢«ä¿å­˜åœ¨å †ä¸Šçš„ Promise å¯¹è±¡ä¸­ï¼Œè¿™ä¹Ÿæ˜¯ç¼–è¯‘å™¨ä¼šåœ¨åç¨‹é‡Œé¢æ’å…¥ Promise ç›¸å…³ä»£ç ï¼Œä»¥åŠä¸€äº›æ‰§è¡Œç‚¹ã€‚ç”±äº Promise çš„å¤§å°å¯ä»¥åœ¨ç¼–è¯‘æœŸè®¡ç®—å‡ºæ¥ï¼Œä»è€Œé¿å…äº†å†…å­˜æµªè´¹ã€‚è€Œ Promise å¯¹è±¡æ‰€æœ‰æƒå¯ç”±<code>coroutine_handle</code> å¥æŸ„æŒæœ‰ã€‚</p>
<h3 id="Future">Future</h3>
<p>è€Œ Future å¯¹è±¡ä¸»è¦æ˜¯ä¸ Promise å¯¹è±¡äº¤äº’çš„æ¡¥æ¢ï¼Œæ—¢ caller ä¸ callee ä¹‹é—´çš„é€šä¿¡ï¼š</p>
<ul>
<li>callee æŒ‚èµ·æ—¶ï¼Œå°†å€¼è¿”å›ç»™ caller: yield è¯­ä¹‰</li>
<li>callee æ‰§è¡Œç»“æŸæ—¶ï¼Œå°†å€¼è¿”å›ç»™ caller: return è¯­ä¹‰</li>
<li>callee æ¢å¤æ—¶ï¼Œcaller å°†å€¼å¸¦ç»™ callee</li>
</ul>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™äº›æ¦‚å¿µå’Œæ ‡å‡†åº“çš„ <code>std::promise/std::future</code> ä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼Œåè€…ç”¨äºåšåŒæ­¥ç”¨ï¼Œ<code>std::future</code>ä¼šé˜»å¡ç­‰å¾…ç›´åˆ° <code>std::promise</code> æä¾›å€¼ï¼Œå¯ä»¥çœ‹åšæ˜¯æ¡ä»¶å˜é‡çš„å°è£…ï¼ŒåŒæ ·åœ°ï¼Œå’Œå…¶ä»–è¯­è¨€çš„ Promise/Future æ¦‚å¿µä¹Ÿä¸ä¸€æ ·ã€‚</p>
<h3 id="Awaitable">Awaitable</h3>
<p>å¦‚æœä¸€ä¸ªå¯¹è±¡æ˜¯ Awaitable å¯¹è±¡ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ co_await æ“ä½œç¬¦å»è§¦å‘è¯¥å¯¹è±¡çš„åŠ¨ä½œ ready/suspend/resumeï¼Œä»è€Œè½¬ç§»ã€æ¢å¤æ§åˆ¶æƒï¼Œco_await ç»†èŠ‚ç•™åˆ°åé¢åœ¨ä»‹ç»ã€‚</p>
<h2 id="å…·ä½“æœºåˆ¶">å…·ä½“æœºåˆ¶</h2>
<p>äº†è§£äº†æ¦‚å¿µæ¨¡å‹åï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥æ¢è®¨èƒŒåçš„æœºåˆ¶äº†ã€‚</p>
<h3 id="Promise-Future å¯¹è±¡">Promise/Future å¯¹è±¡</h3>
<p>å½“ä¸€ä¸ªåç¨‹è¢«è°ƒç”¨æ—¶ï¼Œä¼šåˆ›å»º Promise å¯¹è±¡ï¼Œç„¶åç¼–è¯‘å™¨ä¼šåœ¨å„ä¸ªé˜¶æ®µæ’å…¥ä¸€äº›ä»£ç <sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>ï¼š</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token punctuation">&#123;</span>
  <span class="token keyword">co_await</span> promise<span class="token punctuation">.</span><span class="token function">initial_suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span>
  <span class="token punctuation">&#123;</span>
    <span class="token operator">&lt;</span>body<span class="token operator">-</span>statements<span class="token operator">></span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    promise<span class="token punctuation">.</span><span class="token function">unhandled_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
FinalSuspend<span class="token operator">:</span>
  <span class="token keyword">co_await</span> promise<span class="token punctuation">.</span><span class="token function">final_suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>å¯ä»¥çœ‹åˆ°ä¸€ä¸ªåç¨‹å‡½æ•°ï¼Œåˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>ä»å †ä¸Š (operator new) åˆ›å»º Promise å¯¹è±¡ï¼Œä¿å­˜åç¨‹çš„çŠ¶æ€ä¿¡æ¯</li>
<li>initial_suspend é˜¶æ®µï¼Œç”¨äºåœ¨æ‰§è¡Œåç¨‹ä¸»ä½“ <code>&lt;body-statements&gt;</code> ä»£ç å‰åšäº›äº‹æƒ…</li>
<li><code>&lt;body-statements&gt;</code>é˜¶æ®µï¼Œæ‰§è¡Œåç¨‹çš„ä¸»ä½“ä»£ç </li>
<li>unhandled_exception é˜¶æ®µï¼Œè‹¥æŠ›å¼‚å¸¸ï¼Œå¤„ç†å¼‚å¸¸</li>
<li>final_suspend é˜¶æ®µï¼Œåç¨‹ç»“æŸæ”¶å°¾åŠ¨ä½œï¼Œåœ¨è¿™é˜¶æ®µçš„ <code>coroutine_handle&lt;Promise&gt;::done</code> æ–¹æ³•ä¸º trueï¼Œcaller å¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•åˆ¤æ–­åç¨‹æ˜¯å¦ç»“æŸï¼Œä»è€Œä¸å†è°ƒç”¨ resume æ¢å¤åç¨‹</li>
</ol>
<p>è€Œåç¨‹è¿”å›ç±»å‹åˆ™æ˜¯ä¸€ä¸ª Future å¯¹è±¡ï¼Œè¿™ä¸€æ­¥ç¼–è¯‘å™¨é€šè¿‡ <code>Promise::get_return_object()</code> æ¥åˆ›å»º Future å¯¹è±¡ã€‚è€Œ Future å¯¹è±¡ä¸€èˆ¬æŒæœ‰ Promise çš„å¥æŸ„ï¼š<code>coroutine_handle&lt;Promise&gt;</code>ï¼Œè¿™æ · caller å¯ä»¥é€šè¿‡ Future ä¸ Promise äº¤äº’ï¼Œä»è€Œæ¢å¤åç¨‹ã€‚</p>
<p>è€Œ Promise å¯¹è±¡é‡Šæ”¾çš„æ—¶é—´ç‚¹æœ‰ä¸¤ä¸ªï¼Œé¿å…é‡å¤æ‰§è¡Œï¼Œå¦åˆ™ä¼š double freeï¼š</p>
<ul>
<li>final_suspend é˜¶æ®µ resume å</li>
<li>è°ƒç”¨ <code>coroutine_handle&lt;Promise&gt;::destroy()</code> æ–¹æ³•</li>
</ul>
<p>æ¯”è¾ƒå¥½çš„åšæ³•æ˜¯åœ¨ final_suspend é˜¶æ®µæŒ‚èµ·ï¼Œè¿™æ—¶å€™å°±ä¸å¯ resume äº†ï¼Œåœ¨ caller é€šè¿‡è°ƒç”¨ Future æŒæœ‰çš„å¥æŸ„ <code>destroy()</code> æ–¹æ³•é‡Šæ”¾ Promise å¯¹è±¡ã€‚</p>
<p>ç»¼ä¸Šï¼Œä¸€ä¸ª Promise å¯¹è±¡éœ€è¦å®ç°å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<ul>
<li>initial_suspend: è¿”å›ä¸€ä¸ª Awaitable å¯¹è±¡</li>
<li>final_suspend: è¿”å›ä¸€ä¸ª Awaitable å¯¹è±¡</li>
<li>get_return_object: è¿”å›ä¸€ä¸ª Future å¯¹è±¡ç»™ caller</li>
<li>unhandled_exception: å¤„ç†å¼‚å¸¸</li>
<li>return_value/return_void: co_return æ—¶è¿”å›å€¼ç»™ caller</li>
<li>yield_value: æŒ‚èµ·æ—¶è¿”å›å€¼ç»™ caller</li>
</ul>
<p>å†æ¥çœ‹çœ‹å…¶ <code>coroutine_handle&lt;Promise&gt;</code> å¥æŸ„ç¼–è¯‘å™¨æä¾›äº†å“ªäº›ä¸»è¦æ–¹æ³•ï¼š</p>
<ul>
<li>destroy: é”€æ¯ Promise å¯¹è±¡</li>
<li>from_promise: é™æ€æ–¹æ³•ï¼Œä» Promise å¯¹è±¡è¿”å›å…¶ <code>coroutine_handle</code> å¥æŸ„</li>
<li>done: æ˜¯å¦å¤„äº final_suspend é˜¶æ®µ</li>
<li>promise: è¿”å› Promise å¯¹è±¡å¼•ç”¨</li>
<li>resume/operator(): æ¢å¤åˆ°åç¨‹</li>
</ul>
<h3 id="Awaitable å¯¹è±¡">Awaitable å¯¹è±¡</h3>
<p>å‰é¢æåˆ°çš„ co_await å…³é”®å­—<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup>ï¼Œå…¶æ“ä½œçš„å¯¹è±¡å…¶å®æ˜¯ Awaiter å¯¹è±¡ï¼Œè‹¥å¯¹è±¡å®ç°å¦‚ä¸‹æ–¹æ³•ï¼Œåˆ™è¯´æ˜è¯¥å¯¹è±¡æ˜¯ Awaitable çš„ï¼š</p>
<ul>
<li>await_ready</li>
<li>await_suspend(<code>coroutine_handle&lt;&gt;</code>)</li>
<li>await_resume</li>
</ul>
<p>é‚£ä¹ˆå½“æ‰§è¡Œ <code>co_await &lt;expr&gt;</code> è¡¨è¾¾å¼æ—¶ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆå¦‚ä¸‹ä»£ç ï¼š</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token punctuation">&#123;</span>
  <span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> value <span class="token operator">=</span> <span class="token operator">&lt;</span>expr<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> awaitable <span class="token operator">=</span> <span class="token function">get_awaitable</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">decltype</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> awaiter <span class="token operator">=</span> <span class="token function">get_awaiter</span><span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">decltype</span><span class="token punctuation">(</span>awaitable<span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">(</span>awaitable<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>awaiter<span class="token punctuation">.</span><span class="token function">await_ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token operator">&lt;</span>suspend<span class="token operator">-</span>coroutine<span class="token operator">></span>

    <span class="token comment">//if await_suspend returns void</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        awaiter<span class="token punctuation">.</span><span class="token function">await_suspend</span><span class="token punctuation">(</span>coroutine_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">return_to_the_caller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        exception <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">current_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> resume_point<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//endif</span>
    <span class="token comment">//if await_suspend returns bool</span>
    <span class="token keyword">bool</span> await_suspend_result<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        await_suspend_result <span class="token operator">=</span> awaiter<span class="token punctuation">.</span><span class="token function">await_suspend</span><span class="token punctuation">(</span>coroutine_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        exception <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">current_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> resume_point<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">not</span> await_suspend_result<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> resume_point<span class="token punctuation">;</span>
    <span class="token function">return_to_the_caller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//endif</span>
    <span class="token comment">//if await_suspend returns another coroutine_handle</span>
    <span class="token keyword">decltype</span><span class="token punctuation">(</span>awaiter<span class="token punctuation">.</span><span class="token function">await_suspend</span><span class="token punctuation">(</span>std<span class="token operator">::</span>declval<span class="token operator">&lt;</span>coro_handle_t<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> another_coro_handle<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        another_coro_handle <span class="token operator">=</span> awaiter<span class="token punctuation">.</span><span class="token function">await_suspend</span><span class="token punctuation">(</span>coroutine_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        exception <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">current_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> resume_point<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    another_coro_handle<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">return_to_the_caller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//endif</span>
  <span class="token punctuation">&#125;</span>
  resume_point<span class="token operator">:</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span>
  std<span class="token operator">::</span><span class="token function">rethrow_exception</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token string">"return"</span> awaiter<span class="token punctuation">.</span><span class="token function">await_resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>ä¹Ÿå°±æ˜¯ï¼š</p>
<ol>
<li>é€šè¿‡ <code>&lt;expr&gt;</code> æ‹¿åˆ° Awaiter å¯¹è±¡</li>
<li>é€šè¿‡ Awaiter.await_ready()æ–¹æ³•åˆ¤æ–­æ˜¯å¦éœ€è¦æŒ‚èµ·ï¼Œè‹¥ä¸º true åˆ™æ— éœ€æŒ‚èµ·</li>
<li>åˆ¤æ–­ Awaiter.await_suspend()çš„è¿”å›å€¼ç±»å‹ï¼š
<ul>
<li>voidï¼Œæ— è¿”å›å€¼ï¼Œç›´æ¥æŒ‚èµ·è¿”å› caller</li>
<li>boolï¼Œè‹¥ä¸º trueï¼Œåˆ™è¿”æŒ‚èµ·è¿”å› callerï¼Œå¦åˆ™ä¸æŒ‚èµ·ï¼Œç›´æ¥ resume</li>
<li><code>coroutine_handle&lt;&gt;</code>, åˆ™æŒ‚èµ·å¹¶å°†æ§åˆ¶æƒè½¬ç§»åˆ°å¦ä¸€ä¸ªåç¨‹ä¸Šï¼Œå¦ä¸€ä¸ªåç¨‹å¯ä»¥å† resume å›æ¥ï¼Œåˆ°è¾¾<code>resume_point</code>ã€‚</li>
</ul>
</li>
<li>Awaiter.await_resume()çš„è¿”å›å€¼å³ä¸º co_await çš„ç»“æœ</li>
</ol>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè°æ¥åˆ›å»º Awaiter å¯¹è±¡å‘¢ï¼Ÿæœ‰ä¸¤ç§æ–¹æ³•ï¼š</p>
<ol>
<li>é€šè¿‡ Promise å¯¹è±¡çš„ <code>await_transform(&lt;expr&gt;)</code> æ–¹æ³•ï¼Œå¾—åˆ° Awaiter å¯¹è±¡</li>
<li>é€šè¿‡é‡è½½ operator co_await æ“ä½œç¬¦ï¼Œå¾—åˆ° Awaiter å¯¹è±¡</li>
<li>ç›´æ¥ç”¨ Awaitable å¯¹è±¡</li>
</ol>
<p>æ ‡å‡†åº“é‡Œé¢å®ç°äº†ä¸¤ç§ Awaiterï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">suspend_never</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">bool</span> <span class="token function">await_ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">await_suspend</span><span class="token punctuation">(</span>coroutine_handle<span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">await_resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">suspend_always</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">bool</span> <span class="token function">await_ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">await_suspend</span><span class="token punctuation">(</span>coroutine_handle<span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">await_resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
</code></pre>
<p>ä¸»è¦åœ¨ <code>await_ready</code> é˜¶æ®µåˆ¤æ–­æ˜¯å¦éœ€è¦æŒ‚èµ·åç¨‹ã€‚</p>
<p>æœ€å <code>co_yield &lt;expr&gt;</code> å…¶å®æ˜¯ co_await çš„è¯­æ³•ç³–ï¼Œç”Ÿæˆå¦‚ä¸‹ä»£ç ï¼š</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">co_await</span> promise<span class="token punctuation">.</span><span class="token function">yield_value</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>è€Œ co_return åˆ™ä¼šè°ƒç”¨ Promise å¯¹è±¡çš„ return_void/return_value æ–¹æ³•ã€‚</p>
<h2 id="åç¨‹å®æˆ˜">åç¨‹å®æˆ˜</h2>
<p>æœ‰äº†ä»¥ä¸ŠçŸ¥è¯†ï¼Œåº”è¯¥è¶³å¤Ÿå®ç°ä¸€äº›åç¨‹äº†ã€‚</p>
<p>ä¸ºäº†ç®€å•èµ·è§ï¼Œè¿™é‡Œæˆ‘å®ç°ä¸€ä¸ª Fibonacci çš„ç”Ÿæˆå™¨ï¼Œå®Œæ•´ä»£ç å¯ä»¥è§ï¼š
<a target="_blank" rel="noopener" href="https://github.com/netcan/recipes/blob/master/cpp/coroutine/FibonacciGen.cpp">https://github.com/netcan/recipes/blob/master/cpp/coroutine/FibonacciGen.cpp</a></p>
<p>é¦–å…ˆå…ˆå†™åç¨‹å‡½æ•°ï¼Œå¹¶åœ¨ main caller ä¸­è°ƒç”¨ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp">FiboFuture <span class="token function">generate_fibo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">co_yield</span> j<span class="token punctuation">;</span>
        std<span class="token operator">::</span><span class="token function">tie</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span> <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span> i <span class="token operator">+</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> x <span class="token operator">=</span> <span class="token function">generate_fibo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> x<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"fibo:"</span> <span class="token operator">&lt;&lt;</span> x <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>æ¥ç€å®ç°æˆ‘ä»¬æ‰€éœ€è¦çš„ Proimse å¯¹è±¡ï¼Œç”¨äºå°†ç»“æœä¼ ç»™ callerï¼š</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">promise_type</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> value_<span class="token punctuation">;</span> <span class="token comment">// è¿”å›ç»“æœç»™ caller</span>
    <span class="token keyword">auto</span> <span class="token function">initial_suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> suspend_never<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">auto</span> <span class="token function">final_suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> suspend_always<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// final_suspend æŒ‚èµ·ï¼Œç”± FiboFuture é‡Šæ”¾ promise å¯¹è±¡</span>
    FiboFuture <span class="token function">get_return_object</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token class-name">coroutine_handle</span><span class="token operator">&lt;</span>promise_type<span class="token operator">></span><span class="token operator">::</span><span class="token function">from_promise</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// è¿”å› FiboFuture å¯¹è±¡</span>
    <span class="token keyword">void</span> <span class="token function">unhandled_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> std<span class="token operator">::</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

    <span class="token keyword">auto</span> <span class="token function">yield_value</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// yield ä¸€ä¸ªå€¼å¹¶æŒ‚èµ·è¿”å› caller</span>
        value_ <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token keyword">return</span> suspend_always<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">void</span> <span class="token function">return_void</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>
<p>è¿˜æœ‰å¯¹åº”çš„ Futureï¼š</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">FiboFuture</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">promise_type</span><span class="token punctuation">;</span>
    <span class="token function">FiboFuture</span><span class="token punctuation">(</span>coroutine_handle<span class="token operator">&lt;</span>promise_type<span class="token operator">></span> handle<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">handle_</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

    <span class="token keyword">operator</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> handle_<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">void</span> <span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> handle_<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> handle_<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token operator">~</span><span class="token function">FiboFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> handle_<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    coroutine_handle<span class="token operator">&lt;</span>promise_type<span class="token operator">></span> handle_<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>
<p>ä¸€åˆ‡æå®šï¼Œè¿™å°±æ˜¯ç›®å‰ç”Ÿæˆå™¨çš„å®ç°ï¼Œå¾…åç»­é›†æˆåˆ°æ ‡å‡†åº“ä¸­å»ï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªä¾‹å­æ˜¯ caller/callee ç›¸äº’åä½œï¼Œäº’ç›¸é€šä¿¡å®Œæˆä»»åŠ¡ï¼Œå…·ä½“è§ï¼š
<a target="_blank" rel="noopener" href="https://github.com/netcan/recipes/blob/master/cpp/coroutine/DoubleClick.cpp">https://github.com/netcan/recipes/blob/master/cpp/coroutine/DoubleClick.cpp</a></p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æœŸå¾… C++20 åç¨‹çš„ç¨³å®šæˆç†Ÿï¼Œè¿™æ ·å†™ä¸šåŠ¡ä»£ç å°±ç®€å•å¤šäº†ï¼Œå¿ƒæ™ºè´Ÿæ‹…æ²¡é‚£ä¹ˆé‡äº†ã€‚</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://mthli.xyz/stackful-stackless/">æœ‰æ ˆåç¨‹ä¸æ— æ ˆåç¨‹</a> <a href="#fnref1" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://github.com/CppCon/CppCon2016/blob/master/Presentations/Introduction%20to%20C%2B%2B%20Coroutines/Introduction%20to%20C%2B%2B%20Coroutines%20-%20James%20McNellis%20-%20CppCon%202016.pdf">Introduction to C++ Coroutines - James McNellis</a> <a href="#fnref2" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn3" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://lewissbaker.github.io/2018/09/05/understanding-the-promise-type">C++ Coroutines: Understanding the promise type</a> <a href="#fnref3" class="footnote-backref">â†©ï¸</a></p>
</li>
<li id="fn4" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://blog.panicsoftware.com/co_awaiting-coroutines/">CO_AWAITING COROUTINES</a> <a href="#fnref4" class="footnote-backref">â†©ï¸</a></p>
</li>
</ol>
</section>

    
  </div>

</article>


   
       <div class="original">
    <ul>
        <li>æœ¬æ–‡æ ‡é¢˜ï¼šC++20 åç¨‹åˆæ¢</li>
        <li>æœ¬æ–‡å­—æ•°ï¼š2.4k</li>
        <li>æœ¬æ–‡ä½œè€…ï¼šNetcan</li>
        <li>å‘å¸ƒæ—¶é—´ï¼š2020å¹´09æœˆ05æ—¥ - 14æ—¶36åˆ†</li>
        <li>æœ€åæ›´æ–°ï¼š2022å¹´12æœˆ09æ—¥ - 19æ—¶02åˆ†</li>
        <li>åŸå§‹é“¾æ¥ï¼š<a href="https://netcan.github.io/2020/09/05/C-20%E5%8D%8F%E7%A8%8B/">https://netcan.github.io/2020/09/05/C-20åç¨‹/</a></li>
        <li>ç‰ˆæƒå£°æ˜ï¼š<i class="icon icon-cc"></i><a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="ä¸­å›½å¤§é™† (CC BY-NC-SA 3.0 CN)" rel="external nofollow noopener noreferrer" target="_blank">"ç½²å-éå•†ç”¨-ç›¸åŒæ–¹å¼å…±äº« 3.0"</a>è½¬è½½è¯·ä¿ç•™åŸæ–‡é“¾æ¥åŠä½œè€…ã€‚</li>
    </ul>
</div>

   

   
  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">æ”¯æŒä¸€ä¸‹</span>
      <div class="donation-body">
        <div class="tip text-center">æ‰«ä¸€æ‰«ï¼Œæ”¯æŒNetcan</div>
        <ul>
        
          <li class="item">
            
              <span>å¾®ä¿¡æ‰«ä¸€æ‰«</span>
            
            <img src="/images/qr-wechat.png" alt="">
          </li>
        
          <li class="item">
            
              <span>æ”¯ä»˜å®æ‰«ä¸€æ‰«</span>
            
            <img src="/images/qr-alipay.png" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>


   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2020/08/30/C-%E5%85%83%E7%BC%96%E7%A8%8B%E4%B9%8B%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%EF%BC%9A%E8%AE%BE%E8%AE%A1%E5%B9%B6%E5%AE%9E%E7%8E%B0%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84DSL/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2020/09/16/C-%E5%85%83%E7%BC%96%E7%A8%8B%E4%B9%8BParser-Combinator/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>



<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js"></script>
<script>
    $(".article-content img").wrap(function() {
        return '<a data-fancybox href="' + $(this).attr("src") + '"/>';
    });
</script>


  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">å…³é—­</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              åšå®¢
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/category/"
              rel="noopener noreferrer"
              target="_self"
              >
              åˆ†ç±»
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              rel="noopener noreferrer"
              target="_self"
              >
              æ ‡ç­¾
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              å…³äº
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/atom.xml"
              rel="noopener noreferrer"
              target="_blank"
              >
              RSS
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              rel="noopener noreferrer"
              target="_self"
              >
              æœç´¢
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    

    
    

    

    
    

    

<!-- Gitalkè¯„è®ºæ’ä»¶é€šç”¨ä»£ç  -->
<div id="gitalk-container"></div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>
<script>
const gitalk = new Gitalk({
  clientID: '893a4103795fc66cd8e7',
  clientSecret: '35c92c3dca938831b67dc22e46d64bc9073ebacf',
  repo: 'netcan.github.io',
  owner: 'Netcan',
  // åœ¨è¿™é‡Œè®¾ç½®ä¸€ä¸‹æˆªå–å‰50ä¸ªå­—ç¬¦ä¸², è¿™æ˜¯å› ä¸º github å¯¹ label çš„é•¿åº¦æœ‰äº†è¦æ±‚, å¦‚æœè¶…è¿‡
  // 50ä¸ªå­—ç¬¦ä¸²åˆ™ä¼šæŠ¥é”™.
  // id: location.pathname.split('/').pop().substring(0, 49),
  id: md5(location.pathname),
  admin: ['Netcan'],
  // facebook-like distraction free mode
  distractionFreeMode: false
})
gitalk.render('gitalk-container')
</script>
<!-- Gitalkä»£ç ç»“æŸ -->



  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>
</html>
